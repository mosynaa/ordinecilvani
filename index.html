<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catalogo Ordini</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f2f2f2;
    margin: 0; padding: 20px;
    color: #333;
  }
  h1 {
    color: #007BFF;
    text-align: center;
  }
  #filter-category {
    margin-bottom: 15px;
    padding: 8px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  #search-box {
    margin-bottom: 15px;
    padding: 8px;
    font-size: 16px;
    width: 100%;
    max-width: 300px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 12px 10px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  th {
    background: #007BFF;
    color: white;
  }
  tr:hover {
    background: #FF7F00;
    color: white;
  }
  input.quantity-input {
    width: 80px;
    padding: 5px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  button#generate-pdf {
    margin-top: 15px;
    background-color: #007BFF;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }
  button#generate-pdf:hover {
    background-color: #0056b3;
  }
</style>
</head>
<body>

<h1>Catalogo Ordini</h1>

<select id="filter-category">
  <option value="all">Tutte le categorie</option>
</select>

<input type="text" id="search-box" placeholder="Cerca prodotto..." />

<table>
  <thead>
    <tr>
      <th>Codice</th>
      <th>Descrizione</th>
      <th>Prezzo</th>
      <th>Quantità</th>
    </tr>
  </thead>
  <tbody id="product-list">
    <!-- righe prodotti qui -->
  </tbody>
</table>

<button id="generate-pdf">Genera PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="catalogo.csv" type="text/csv"></script>
<script>
(async function() {
  // Carica CSV da catalogo.csv
  const response = await fetch('catalogo.csv');
  const csvText = await response.text();

  // Parsing CSV semplice
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].toLowerCase().split(',');
    return lines.slice(1).map(line => {
      const values = line.split(',');
      let obj = {};
      headers.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : '');
      return obj;
    });
  }

  let products = parseCSV(csvText);

  // Popola select categorie uniche
  const categorySet = new Set(products.map(p => p.categoria || p.category || ''));
  const categorySelect = document.getElementById('filter-category');
  categorySet.forEach(cat => {
    if(cat) {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    }
  });

  const productList = document.getElementById('product-list');
  const searchBox = document.getElementById('search-box');

  function renderProducts() {
    const filterCat = categorySelect.value;
    const searchTerm = searchBox.value.toLowerCase();

    productList.innerHTML = '';

    products.forEach((p, idx) => {
      if ((filterCat === 'all' || p.categoria === filterCat) &&
          (p.descrizione.toLowerCase().includes(searchTerm) || p.codice.toLowerCase().includes(searchTerm))) {
        const tr = document.createElement('tr');

        const tdCodice = document.createElement('td');
        tdCodice.textContent = p.codice;
        tr.appendChild(tdCodice);

        const tdDesc = document.createElement('td');
        tdDesc.textContent = p.descrizione;
        tr.appendChild(tdDesc);

        const tdPrezzo = document.createElement('td');
        tdPrezzo.textContent = p.prezzo || 'p.p.';
        tr.appendChild(tdPrezzo);

        const tdQty = document.createElement('td');
        const qtyInput = document.createElement('input');
        qtyInput.type = 'text';
        qtyInput.className = 'quantity-input';
        qtyInput.placeholder = 'es. 5 pz';
        qtyInput.dataset.idx = idx;  // per riconoscere prodotto se serve
        tdQty.appendChild(qtyInput);
        tr.appendChild(tdQty);

        productList.appendChild(tr);
      }
    });
  }

  categorySelect.addEventListener('change', renderProducts);
  searchBox.addEventListener('input', renderProducts);

  renderProducts();

  // Nome cliente e note
  let clienteNome = '';
  let noteOrdine = '';

  // Aggiungiamo prompt prima di generare PDF
  document.getElementById('generate-pdf').addEventListener('click', () => {
    clienteNome = prompt('Inserisci il nome del cliente:', clienteNome || '');
    if(clienteNome === null) return; // annulla

    noteOrdine = prompt('Eventuali note per l\'ordine (lascia vuoto se nessuna):', noteOrdine || '');

    generatePDF();
  });

  function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFont('Poppins', 'normal');
    doc.setFontSize(18);
    doc.setTextColor('#007BFF');
    doc.text('Ordine per: ' + clienteNome, 10, 20);

    doc.setFontSize(12);
    doc.setTextColor('#000');

    let y = 35;
    doc.text('Codice', 10, y);
    doc.text('Descrizione', 40, y);
    doc.text('Quantità', 130, y);
    doc.text('Prezzo', 160, y);
    y += 7;

    const rows = [];

    // Prendo solo prodotti con quantità inserita
    document.querySelectorAll('.quantity-input').forEach(input => {
      const val = input.value.trim();
      if(val !== '') {
        const idx = input.dataset.idx;
        const p = products[idx];
        const prezzo = p.prezzo || 'p.p.';
        rows.push([p.codice, p.descrizione, val, prezzo]);
      }
    });

    rows.forEach(r => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(r[0], 10, y);
      doc.text(r[1], 40, y);
      doc.text(r[2], 130, y);
      doc.text(r[3], 160, y);
      y += 7;
    });

    if(noteOrdine){
      if (y > 270) doc.addPage();
      y += 10;
      doc.setTextColor('#FF7F00');
      doc.text('Note:', 10, y);
      y += 7;
      doc.setTextColor('#000');
      const splitNotes = doc.splitTextToSize(noteOrdine, 180);
      doc.text(splitNotes, 10, y);
    }

    doc.save(`ordine_${clienteNome.replace(/\s+/g, '_')}.pdf`);
  }

})();
</script>

</body>
</html>
